trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: DownloadSecureFile@1
    name: sshKey
    inputs:
      secureFile: 'sammymathenge-web.pem'

  - script: |
      # Set correct permissions for the private key
      chmod 600 $(Agent.TempDirectory)/sammymathenge-web.pem

      # Start SSH agent
      eval $(ssh-agent -s)

      # Add SSH private key to the agent
      ssh-add $(Agent.TempDirectory)/sammymathenge-web.pem

      # SSH into the server
      ssh -o StrictHostKeyChecking=no -p $(SSH_PORT) $(SSH_USERNAME)@$(SSH_HOST) << 'EOF'
        echo "SSH connection successful"

        # Navigate to the project directory
        cd pmis

        # Clean up unused Docker images
        sudo docker image prune -af

        # Pull the latest code from the repository
        git reset --hard origin/main
        git pull

        # Build the Docker image with no cache
        sudo docker build --no-cache -t agilesam/pmis:latest .

        # Log in to Docker Hub
        echo "$DOCKER_HUB_PASSWORD" | sudo docker login -u "$DOCKER_HUB_USERNAME" --password-stdin

        # Push the Docker image to Docker Hub
        sudo docker push agilesam/pmis:latest



        echo "Deployment completed successfully"
      EOF
    displayName: 'Deploying to server...'
